{{template "layout.html" .}}

{{define "content"}}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">My Profile</h1>
            <p class="text-muted">Manage your account settings and preferences</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="resetChanges()">
                <i class="bi bi-arrow-clockwise me-2"></i>Reset Changes
            </button>
            <button class="btn btn-outline-info" onclick="exportProfileData()">
                <i class="bi bi-download me-2"></i>Export Data
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Profile Info -->
        <div class="col-lg-4">
            <!-- Profile Card -->
            <div class="card shadow mb-4">
                <div class="card-body text-center">
                    <div class="profile-avatar-section mb-4">
                        <div class="profile-avatar-container position-relative">
                            {{if .User.Avatar}}
                            <img src="{{.User.Avatar}}" class="profile-avatar" alt="Profile Avatar" id="profile-avatar-img">
                            {{else}}
                            <div class="profile-avatar-placeholder" id="profile-avatar-placeholder">
                                {{substring .User.Name 0 1 | upper}}
                            </div>
                            {{end}}
                            <div class="avatar-overlay">
                                <button class="btn btn-sm btn-primary" onclick="changeAvatar()">
                                    <i class="bi bi-camera"></i>
                                </button>
                            </div>
                        </div>
                        <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                    </div>
                    
                    <h5 class="mb-2">{{.User.Name}}</h5>
                    <p class="text-muted mb-3">{{.User.Email}}</p>
                    
                    <div class="profile-badges mb-3">
                        <span class="badge bg-{{if eq .User.Role "admin"}}danger{{else if eq .User.Role "user"}}primary{{else}}secondary{{end}} fs-6">
                            <i class="bi bi-{{if eq .User.Role "admin"}}shield-check{{else if eq .User.Role "user"}}person{{else}}eye{{end}} me-1"></i>
                            {{.User.Role | title}}
                        </span>
                        {{if .User.IsEmailVerified}}
                        <span class="badge bg-success ms-2">
                            <i class="bi bi-check-circle me-1"></i>Verified
                        </span>
                        {{else}}
                        <span class="badge bg-warning ms-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>Unverified
                        </span>
                        {{end}}
                    </div>
                    
                    <div class="profile-stats">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-number">{{.UserStats.TotalWorkflows}}</div>
                                <div class="stat-label">Workflows</div>
                            </div>
                            <div class="col-4">
                                <div class="stat-number">{{.UserStats.TotalExecutions}}</div>
                                <div class="stat-label">Executions</div>
                            </div>
                            <div class="col-4">
                                <div class="stat-number">{{.UserStats.DaysActive}}</div>
                                <div class="stat-label">Days Active</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/workflows" class="btn btn-outline-primary">
                            <i class="bi bi-diagram-3 me-2"></i>My Workflows
                        </a>
                        <a href="/logs?user_id={{.User.ID.Hex}}" class="btn btn-outline-secondary">
                            <i class="bi bi-list-ul me-2"></i>My Activity Logs
                        </a>
                        {{if not .User.IsEmailVerified}}
                        <button class="btn btn-outline-warning" onclick="resendVerification()">
                            <i class="bi bi-envelope-check me-2"></i>Verify Email
                        </button>
                        {{end}}
                        <hr>
                        <button class="btn btn-outline-danger" onclick="deleteAccount()">
                            <i class="bi bi-trash me-2"></i>Delete Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- Account Information -->
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Account Information</h6>
                </div>
                <div class="card-body">
                    <div class="account-info">
                        <div class="info-item">
                            <strong>User ID:</strong>
                            <div class="text-muted">{{.User.ID.Hex}}</div>
                        </div>
                        <div class="info-item">
                            <strong>Member Since:</strong>
                            <div class="text-muted">{{.User.CreatedAt.Format "January 2, 2006"}}</div>
                        </div>
                        <div class="info-item">
                            <strong>Last Login:</strong>
                            <div class="text-muted">
                                {{if .User.LastLoginAt}}
                                {{.User.LastLoginAt.Format "Jan 2, 2006 at 3:04 PM"}}
                                {{else}}
                                Never
                                {{end}}
                            </div>
                        </div>
                        <div class="info-item">
                            <strong>Profile Updated:</strong>
                            <div class="text-muted">{{.User.UpdatedAt.Format "Jan 2, 2006"}}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Settings Forms -->
        <div class="col-lg-8">
            <!-- Profile Settings -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Profile Settings</h6>
                </div>
                <div class="card-body">
                    <form id="profile-form" onsubmit="updateProfile(event)">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-name" class="form-label">
                                        Full Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="profile-name" name="name" 
                                           value="{{.User.Name}}" required maxlength="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-email" class="form-label">
                                        Email Address <span class="text-danger">*</span>
                                    </label>
                                    <input type="email" class="form-control" id="profile-email" name="email" 
                                           value="{{.User.Email}}" required>
                                    <div class="form-text">
                                        {{if .User.IsEmailVerified}}
                                        <i class="bi bi-check-circle text-success me-1"></i>Email verified
                                        {{else}}
                                        <i class="bi bi-exclamation-triangle text-warning me-1"></i>Email not verified
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="profile-phone" name="phone" 
                                           value="{{.User.Phone}}" placeholder="+1 (555) 123-4567">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="profile-timezone" class="form-label">Timezone</label>
                                    <select class="form-select" id="profile-timezone" name="timezone">
                                        <option value="UTC" {{if eq .User.Timezone "UTC"}}selected{{end}}>UTC</option>
                                        <option value="America/New_York" {{if eq .User.Timezone "America/New_York"}}selected{{end}}>Eastern Time</option>
                                        <option value="America/Chicago" {{if eq .User.Timezone "America/Chicago"}}selected{{end}}>Central Time</option>
                                        <option value="America/Denver" {{if eq .User.Timezone "America/Denver"}}selected{{end}}>Mountain Time</option>
                                        <option value="America/Los_Angeles" {{if eq .User.Timezone "America/Los_Angeles"}}selected{{end}}>Pacific Time</option>
                                        <option value="Europe/London" {{if eq .User.Timezone "Europe/London"}}selected{{end}}>London</option>
                                        <option value="Europe/Berlin" {{if eq .User.Timezone "Europe/Berlin"}}selected{{end}}>Berlin</option>
                                        <option value="Asia/Tokyo" {{if eq .User.Timezone "Asia/Tokyo"}}selected{{end}}>Tokyo</option>
                                        <option value="Asia/Shanghai" {{if eq .User.Timezone "Asia/Shanghai"}}selected{{end}}>Shanghai</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="profile-bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="profile-bio" name="bio" rows="3" 
                                      maxlength="500" placeholder="Tell us about yourself...">{{.User.Bio}}</textarea>
                            <div class="form-text">Maximum 500 characters</div>
                        </div>

                        <div class="mb-3">
                            <label for="profile-company" class="form-label">Company</label>
                            <input type="text" class="form-control" id="profile-company" name="company" 
                                   value="{{.User.Company}}" maxlength="100">
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetProfileForm()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Security Settings</h6>
                </div>
                <div class="card-body">
                    <form id="password-form" onsubmit="changePassword(event)">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">
                                Current Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="current-password" 
                                       name="current_password" required>
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="togglePassword('current-password')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="new-password" class="form-label">
                                        New Password <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="new-password" 
                                               name="new_password" required minlength="8" 
                                               onkeyup="checkPasswordStrength(this.value)">
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePassword('new-password')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-strength mt-2">
                                        <div class="progress" style="height: 5px;">
                                            <div class="progress-bar" id="password-strength-bar" 
                                                 style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="password-strength-text">
                                            Password strength will be shown here
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confirm-password" class="form-label">
                                        Confirm New Password <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirm-password" 
                                               name="confirm_password" required minlength="8" 
                                               onkeyup="checkPasswordMatch()">
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="togglePassword('confirm-password')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-match mt-2">
                                        <small class="text-muted" id="password-match-text"></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="password-requirements mb-3">
                            <small class="text-muted">
                                <strong>Password Requirements:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>At least 8 characters long</li>
                                    <li>Include uppercase and lowercase letters</li>
                                    <li>Include at least one number</li>
                                    <li>Include at least one special character</li>
                                </ul>
                            </small>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetPasswordForm()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-shield-check me-2"></i>Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Notification Preferences -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Notification Preferences</h6>
                </div>
                <div class="card-body">
                    <form id="notifications-form" onsubmit="updateNotifications(event)">
                        <div class="notification-section mb-4">
                            <h6 class="notification-category">Email Notifications</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-workflow-success" 
                                       name="notify_workflow_success" {{if .User.Preferences.NotifyWorkflowSuccess}}checked{{end}}>
                                <label class="form-check-label" for="notify-workflow-success">
                                    Workflow execution success
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-workflow-failure" 
                                       name="notify_workflow_failure" {{if .User.Preferences.NotifyWorkflowFailure}}checked{{end}}>
                                <label class="form-check-label" for="notify-workflow-failure">
                                    Workflow execution failure
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-system-updates" 
                                       name="notify_system_updates" {{if .User.Preferences.NotifySystemUpdates}}checked{{end}}>
                                <label class="form-check-label" for="notify-system-updates">
                                    System updates and maintenance
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-security-alerts" 
                                       name="notify_security_alerts" {{if .User.Preferences.NotifySecurityAlerts}}checked{{end}}>
                                <label class="form-check-label" for="notify-security-alerts">
                                    Security alerts and login notifications
                                </label>
                            </div>
                        </div>

                        <div class="notification-section mb-4">
                            <h6 class="notification-category">Dashboard Preferences</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="show-welcome-message" 
                                       name="show_welcome_message" {{if .User.Preferences.ShowWelcomeMessage}}checked{{end}}>
                                <label class="form-check-label" for="show-welcome-message">
                                    Show welcome message on dashboard
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="auto-refresh-dashboard" 
                                       name="auto_refresh_dashboard" {{if .User.Preferences.AutoRefreshDashboard}}checked{{end}}>
                                <label class="form-check-label" for="auto-refresh-dashboard">
                                    Auto-refresh dashboard data
                                </label>
                            </div>
                            <div class="mb-3">
                                <label for="dashboard-refresh-interval" class="form-label">Dashboard refresh interval (seconds)</label>
                                <select class="form-select" id="dashboard-refresh-interval" name="dashboard_refresh_interval">
                                    <option value="30" {{if eq .User.Preferences.DashboardRefreshInterval 30}}selected{{end}}>30 seconds</option>
                                    <option value="60" {{if eq .User.Preferences.DashboardRefreshInterval 60}}selected{{end}}>1 minute</option>
                                    <option value="300" {{if eq .User.Preferences.DashboardRefreshInterval 300}}selected{{end}}>5 minutes</option>
                                    <option value="600" {{if eq .User.Preferences.DashboardRefreshInterval 600}}selected{{end}}>10 minutes</option>
                                </select>
                            </div>
                        </div>

                        <div class="notification-section">
                            <h6 class="notification-category">Theme Preferences</h6>
                            <div class="mb-3">
                                <label for="theme-preference" class="form-label">Theme</label>
                                <select class="form-select" id="theme-preference" name="theme" onchange="previewTheme(this.value)">
                                    <option value="light" {{if eq .User.Preferences.Theme "light"}}selected{{end}}>Light</option>
                                    <option value="dark" {{if eq .User.Preferences.Theme "dark"}}selected{{end}}>Dark</option>
                                    <option value="auto" {{if eq .User.Preferences.Theme "auto"}}selected{{end}}>Auto (System)</option>
                                </select>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetNotificationsForm()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-bell-check me-2"></i>Update Preferences
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Active Sessions -->
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Active Sessions</h6>
                </div>
                <div class="card-body">
                    <div class="sessions-list">
                        {{if .ActiveSessions}}
                        {{range .ActiveSessions}}
                        <div class="session-item d-flex align-items-center justify-content-between mb-3 p-3 border rounded">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-{{if eq .DeviceType "desktop"}}laptop{{else if eq .DeviceType "mobile"}}phone{{else}}tablet{{end}} session-icon me-3"></i>
                                <div>
                                    <div class="fw-bold">{{.Browser}} on {{.OS}}</div>
                                    <div class="text-muted small">
                                        {{.Location}} â€¢ Last active: {{.LastActivity.Format "Jan 2, 3:04 PM"}}
                                    </div>
                                    {{if .IsCurrent}}
                                    <span class="badge bg-success">Current Session</span>
                                    {{end}}
                                </div>
                            </div>
                            <div>
                                {{if not .IsCurrent}}
                                <button class="btn btn-sm btn-outline-danger" onclick="terminateSession('{{.ID}}')">
                                    <i class="bi bi-x-circle"></i> Terminate
                                </button>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                        <div class="mt-3 text-center">
                            <button class="btn btn-outline-warning" onclick="terminateAllSessions()">
                                <i class="bi bi-power me-2"></i>Terminate All Other Sessions
                            </button>
                        </div>
                        {{else}}
                        <div class="text-center py-4">
                            <i class="bi bi-shield-check" style="font-size: 3rem; color: #6c757d;"></i>
                            <h6 class="mt-3">Only Current Session Active</h6>
                            <p class="text-muted">You have no other active sessions</p>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Alerts Container -->
<div id="alerts-container" class="position-fixed" style="top: 20px; right: 20px; z-index: 9999;"></div>
{{end}}

{{define "scripts"}}
<style>
/* User Profile Styles */
.profile-avatar-container {
    display: inline-block;
    position: relative;
}

.profile-avatar,
.profile-avatar-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.profile-avatar-placeholder {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 3rem;
}

.avatar-overlay {
    position: absolute;
    bottom: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    padding: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.profile-avatar-container:hover .avatar-overlay {
    opacity: 1;
}

.profile-badges {
    margin-bottom: 1rem;
}

.profile-stats {
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-info .info-item {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #f1f3f4;
}

.account-info .info-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.notification-section {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
}

.notification-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.notification-category {
    color: #007bff;
    font-size: 1rem;
    margin-bottom: 0.75rem;
}

.session-item {
    background-color: #f8f9fa;
    transition: background-color 0.2s;
}

.session-item:hover {
    background-color: #e9ecef;
}

.session-icon {
    font-size: 1.5rem;
    color: #007bff;
}

.password-strength .progress-bar {
    transition: all 0.3s ease;
}

.password-strength .progress-bar.weak {
    background-color: #dc3545;
}

.password-strength .progress-bar.medium {
    background-color: #ffc107;
}

.password-strength .progress-bar.strong {
    background-color: #28a745;
}

.form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Theme preview */
.theme-preview {
    border: 2px solid #007bff;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .profile-avatar,
    .profile-avatar-placeholder {
        width: 100px;
        height: 100px;
    }
    
    .stat-number {
        font-size: 1.25rem;
    }
    
    .stat-label {
        font-size: 0.75rem;
    }
}
</style>

<script>
// Profile management
async function updateProfile(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const profileData = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/api/v1/auth/preferences', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(notificationData)
        });

        if (response.ok) {
            showAlert('Notification preferences updated successfully!', 'success');
        } else {
            const error = await response.json();
            showAlert(error.message || 'Failed to update preferences', 'danger');
        }
    } catch (error) {
        showAlert('Error updating preferences', 'danger');
    }
}

// Avatar management
function changeAvatar() {
    document.getElementById('avatar-upload').click();
}

async function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showAlert('Please select a valid image file', 'warning');
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showAlert('Image size must be less than 5MB', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('avatar', file);
    
    try {
        const response = await fetch('/api/v1/auth/avatar', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            const avatarUrl = result.data.avatar_url;
            
            // Update avatar display
            const avatarImg = document.getElementById('profile-avatar-img');
            const avatarPlaceholder = document.getElementById('profile-avatar-placeholder');
            
            if (avatarImg) {
                avatarImg.src = avatarUrl;
            } else if (avatarPlaceholder) {
                avatarPlaceholder.outerHTML = `<img src="${avatarUrl}" class="profile-avatar" alt="Profile Avatar" id="profile-avatar-img">`;
            }
            
            showAlert('Avatar updated successfully!', 'success');
        } else {
            const error = await response.json();
            showAlert(error.message || 'Failed to upload avatar', 'danger');
        }
    } catch (error) {
        showAlert('Error uploading avatar', 'danger');
    }
}

// Security functions
async function resendVerification() {
    try {
        const response = await fetch('/api/v1/auth/resend-verification', {
            method: 'POST'
        });

        if (response.ok) {
            showAlert('Verification email sent! Check your inbox.', 'success');
        } else {
            const error = await response.json();
            showAlert(error.message || 'Failed to send verification email', 'danger');
        }
    } catch (error) {
        showAlert('Error sending verification email', 'danger');
    }
}

async function terminateSession(sessionId) {
    if (confirm('Are you sure you want to terminate this session?')) {
        try {
            const response = await fetch(`/api/v1/auth/sessions/${sessionId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('Session terminated successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Failed to terminate session', 'danger');
            }
        } catch (error) {
            showAlert('Error terminating session', 'danger');
        }
    }
}

async function terminateAllSessions() {
    if (confirm('Are you sure you want to terminate all other sessions? You will remain logged in on this device.')) {
        try {
            const response = await fetch('/api/v1/auth/sessions/terminate-all', {
                method: 'POST'
            });

            if (response.ok) {
                showAlert('All other sessions terminated successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Failed to terminate sessions', 'danger');
            }
        } catch (error) {
            showAlert('Error terminating sessions', 'danger');
        }
    }
}

async function deleteAccount() {
    const confirmation = prompt('To delete your account, type "DELETE" (in capital letters):');
    
    if (confirmation === 'DELETE') {
        if (confirm('Are you absolutely sure? This action cannot be undone and will permanently delete all your data.')) {
            try {
                const response = await fetch('/api/v1/auth/delete-account', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Account deletion initiated. You will be logged out shortly.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Failed to delete account', 'danger');
                }
            } catch (error) {
                showAlert('Error deleting account', 'danger');
            }
        }
    } else if (confirmation !== null) {
        showAlert('Account deletion cancelled. You must type "DELETE" exactly.', 'info');
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    let strength = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) strength += 1;
    else feedback.push('At least 8 characters');
    
    // Uppercase check
    if (/[A-Z]/.test(password)) strength += 1;
    else feedback.push('Uppercase letter');
    
    // Lowercase check
    if (/[a-z]/.test(password)) strength += 1;
    else feedback.push('Lowercase letter');
    
    // Number check
    if (/\d/.test(password)) strength += 1;
    else feedback.push('Number');
    
    // Special character check
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 1;
    else feedback.push('Special character');
    
    // Update UI
    const percentage = (strength / 5) * 100;
    strengthBar.style.width = percentage + '%';
    
    if (strength <= 2) {
        strengthBar.className = 'progress-bar weak';
        strengthText.textContent = `Weak password. Missing: ${feedback.join(', ')}`;
        strengthText.className = 'text-danger';
    } else if (strength <= 3) {
        strengthBar.className = 'progress-bar medium';
        strengthText.textContent = `Medium password. Missing: ${feedback.join(', ')}`;
        strengthText.className = 'text-warning';
    } else {
        strengthBar.className = 'progress-bar strong';
        strengthText.textContent = 'Strong password';
        strengthText.className = 'text-success';
    }
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const matchText = document.getElementById('password-match-text');
    
    if (confirmPassword === '') {
        matchText.textContent = '';
        return;
    }
    
    if (newPassword === confirmPassword) {
        matchText.textContent = 'Passwords match';
        matchText.className = 'text-success';
    } else {
        matchText.textContent = 'Passwords do not match';
        matchText.className = 'text-danger';
    }
}

// Theme management
function previewTheme(theme) {
    const body = document.body;
    
    // Remove existing theme classes
    body.classList.remove('theme-light', 'theme-dark');
    
    if (theme === 'dark') {
        body.classList.add('theme-dark');
    } else if (theme === 'auto') {
        // Detect system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            body.classList.add('theme-dark');
        }
    }
    // Light theme is default (no class needed)
}

// Form management
function resetProfileForm() {
    document.getElementById('profile-form').reset();
    // Reload original values
    location.reload();
}

function resetPasswordForm() {
    document.getElementById('password-form').reset();
    document.getElementById('password-strength-bar').style.width = '0%';
    document.getElementById('password-strength-text').textContent = 'Password strength will be shown here';
    document.getElementById('password-match-text').textContent = '';
}

function resetNotificationsForm() {
    document.getElementById('notifications-form').reset();
    // Reload original values
    location.reload();
}

function resetChanges() {
    if (confirm('Are you sure you want to reset all changes? This will reload the page and lose any unsaved changes.')) {
        location.reload();
    }
}

// Export data
async function exportProfileData() {
    try {
        const response = await fetch('/api/v1/auth/export-data');
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `profile-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('Profile data exported successfully!', 'success');
        } else {
            showAlert('Failed to export profile data', 'danger');
        }
    } catch (error) {
        showAlert('Error exporting profile data', 'danger');
    }
}

// Utility functions
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        button.classList.remove('bi-eye');
        button.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        button.classList.remove('bi-eye-slash');
        button.classList.add('bi-eye');
    }
}

function updateProfileDisplay(profileData) {
    // Update name in profile card
    const nameElements = document.querySelectorAll('.profile-name');
    nameElements.forEach(el => el.textContent = profileData.name);
    
    // Update other displayed information as needed
    if (profileData.bio) {
        const bioElement = document.querySelector('.profile-bio');
        if (bioElement) bioElement.textContent = profileData.bio;
    }
}

function showAlert(message, type) {
    const alertsContainer = document.getElementById('alerts-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.cssText = 'min-width: 300px; margin-bottom: 10px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Template helper functions
function substring(str, start, length) {
    return str.substring(start, start + length);
}

function upper(str) {
    return str.toUpperCase();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set up theme on page load
    const themeSelect = document.getElementById('theme-preference');
    if (themeSelect) {
        previewTheme(themeSelect.value);
    }
    
    // Set up auto-save for non-critical fields
    const profileForm = document.getElementById('profile-form');
    if (profileForm) {
        profileForm.addEventListener('input', debounce(autoSaveProfile, 2000));
    }
});

// Auto-save profile (debounced)
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function autoSaveProfile() {
    // Auto-save non-sensitive profile data
    const formData = new FormData(document.getElementById('profile-form'));
    const profileData = Object.fromEntries(formData.entries());
    
    // Only save basic info, not email or other sensitive data
    const safeData = {
        bio: profileData.bio,
        company: profileData.company,
        timezone: profileData.timezone
    };
    
    fetch('/api/v1/auth/profile/auto-save', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(safeData)
    }).catch(() => {
        // Silently fail for auto-save
    });
}
</script>
{{end}}profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(profileData)
        });

        if (response.ok) {
            showAlert('Profile updated successfully!', 'success');
            // Update profile display
            updateProfileDisplay(profileData);
        } else {
            const error = await response.json();
            showAlert(error.message || 'Failed to update profile', 'danger');
        }
    } catch (error) {
        showAlert('Error updating profile', 'danger');
    }
}

async function changePassword(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const passwordData = Object.fromEntries(formData.entries());
    
    // Validate passwords match
    if (passwordData.new_password !== passwordData.confirm_password) {
        showAlert('New passwords do not match', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/auth/change-password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(passwordData)
        });

        if (response.ok) {
            showAlert('Password changed successfully!', 'success');
            resetPasswordForm();
        } else {
            const error = await response.json();
            showAlert(error.message || 'Failed to change password', 'danger');
        }
    } catch (error) {
        showAlert('Error changing password', 'danger');
    }
}

async function updateNotifications(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const notificationData = {};
    
    // Handle checkboxes properly
    const checkboxes = event.target.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        notificationData[checkbox.name] = checkbox.checked;
    });
    
    // Handle select field
    const selects = event.target.querySelectorAll('select');
    selects.forEach(select => {
        notificationData[select.name] = select.value;
    });
    
    try {
        const response = await fetch('/api/v1/auth/